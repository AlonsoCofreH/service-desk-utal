<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Base de Conocimiento</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>
<body>

  <nav>
    <ul>
      <li><a href="index.html">Inicio</a></li>
      <li><a href="guias.html">Gu√≠as</a></li>
    </ul>
  </nav>

  <header class="guias-header">
    <h1><i class="fas fa-book"></i> Base de Conocimiento</h1>
    <p>Encuentra gu√≠as seg√∫n tu perfil de usuario.</p>
  </header>

  <main class="guias-contenido" id="contenedorArticulos">
    <p>Cargando art√≠culos...</p>
  </main>

  <footer class="guias-footer">
    <p>&copy; 2025 Universidad de Talca - Mesa de Ayuda</p>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const contenedor = document.getElementById("contenedorArticulos");
      const currentUser = JSON.parse(localStorage.getItem("currentUser"));

      if (!currentUser) {
        contenedor.innerHTML = "<p>Debes iniciar sesi√≥n para ver art√≠culos.</p>";
        return;
      }

      const tipo = currentUser.role === "agente" ? "agente" : "usuario";
      const esAgente = currentUser.role === "agente";

      const articulos = await obtenerArticulosPorTipo(tipo);

      if (!articulos.length) {
        contenedor.innerHTML = "<p>No hay art√≠culos disponibles para tu perfil.</p>";
        return;
      }

      contenedor.innerHTML = "";

      articulos.forEach(art => {
        const fecha = art.fechaCreacion?.toDate?.().toLocaleDateString("es-CL") || "Desconocida";
        const vencido = art.fechaVencimiento && new Date(art.fechaVencimiento.toDate?.()) < new Date();
        const claseVencido = vencido ? "despublicado" : "";

        const div = document.createElement("div");
        div.className = `articulo ${claseVencido}`;
        div.innerHTML = `
          <h2>${art.categoria}</h2>
          <p class="meta">Publicado por <strong>${art.autor}</strong> el <em>${fecha}</em></p>
          <p class="contenido">${art.contenido}</p>
          <div class="etiquetas">Visible para: ${art.dirigidoA === "agente" ? "Agentes" : "Usuarios"}</div>
          ${esAgente ? `
            <div style="margin-top: 1rem;">
              <button class="btn-editar" onclick="editarArticulo('${art.id}', this)">‚úèÔ∏è Editar</button>
              <button class="btn-eliminar" onclick="eliminarArticulo('${art.id}', this)">üóëÔ∏è Eliminar</button>
            </div>
          ` : ''}
        `;
        contenedor.appendChild(div);
      });
    });

    // üîß Funci√≥n para eliminar un art√≠culo
    async function eliminarArticulo(id, btn) {
      if (!confirm("¬øEst√°s seguro de eliminar este art√≠culo?")) return;

      try {
        await firebase.firestore().collection("articulos").doc(id).delete();
        btn.closest(".articulo").remove();
        alert("Art√≠culo eliminado.");
      } catch (e) {
        console.error("Error al eliminar:", e);
        alert("No se pudo eliminar.");
      }
    }

    // üìù Funci√≥n para editar un art√≠culo
    async function editarArticulo(id, btn) {
      const contenedor = btn.closest(".articulo");
      const parrafo = contenedor.querySelector(".contenido");
      const textoActual = parrafo.textContent;

      const nuevoContenido = prompt("Editar contenido del art√≠culo:", textoActual);
      if (nuevoContenido === null || nuevoContenido.trim() === "") return;

      try {
        await firebase.firestore().collection("articulos").doc(id).update({
          contenido: nuevoContenido
        });
        parrafo.textContent = nuevoContenido;
        alert("Art√≠culo actualizado.");
      } catch (e) {
        console.error("Error al actualizar:", e);
        alert("No se pudo actualizar.");
      }
    }
  </script>
</body>
</html>
